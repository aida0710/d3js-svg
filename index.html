<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <title>D3.js with Bootstrap</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"
  ></script>
  <link rel="stylesheet" href="style.css" />
  <style></style>
</head>
<body>
  <!-- Add Event Modal -->
  <div
    class="modal fade"
    tabindex="-1"
    id="add-event-modal"
    data-bs-keyboard="false"
    aria-labelledby="addEventModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addEventModalLabel">
            <span id="userName"></span>
          </h5>
        </div>
        <div class="modal-body">
          <form>
            <div>
              <input
                type="text"
                class="form-control fs-5"
                placeholder="予定タイトル"
                autocomplete="off"
              />
            </div>
            <div class="mt-3">
              <div class="input-group">
                <label>
                  <input type="date" class="form-control" />
                </label>
                <select
                  class="form-select form-select-sm"
                  aria-label=".form-select-sm"
                ></select>
                <span class="p-1">–</span>
                <select
                  class="form-select form-select-sm"
                  aria-label=".form-select-sm"
                ></select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            back
          </button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
            follow
          </button>
        </div>
      </div>
    </div>
  </div>

  <svg width="960" height="600" class="graph"></svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script>
    var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var simulation = d3
      .forceSimulation()
      .force(
        "link",
        d3.forceLink().id(function (d) {
          return d.id;
        })
      )
      .force("charge", d3.forceManyBody())
      .force("center", d3.forceCenter(width / 2, height / 2));

    d3.json("miserables.json", function (error, graph) {
      if (error) throw error;

      //
      const userNameSpan = document.getElementById("userName");

      // ノードがクリックされたときの処理
      function nodeClicked(d) {
        userNameSpan.textContent = d.id; // ノードのidをユーザー名として表示
        const modal = new bootstrap.Modal(
          document.getElementById("add-event-modal")
        );
        modal.show();
      }
      //

      var link = svg
        .append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(graph.links)
        .enter()
        .append("line")
        .attr("stroke-width", function (d) {
          return Math.sqrt(d.value);
        });

      var node = svg
        .append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(graph.nodes)
        .enter()
        .append("circle")
        .attr("r", 5)
        .attr("fill", function (d) {
          return color(d.group);
        })
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        )

        .on("mouseover", function (e) {
          console.log("ホバーしたよ");
        })
        .on("mouseout", function (e) {
          console.log("離れたよ");
        })
        .on("click", nodeClicked);

      node.append("title").text(function (d) {
        return d.id;
      });

      simulation.nodes(graph.nodes).on("tick", ticked);

      simulation.force("link").links(graph.links);

      function ticked() {
        link
          .attr("x1", function (d) {
            return d.source.x;
          })
          .attr("y1", function (d) {
            return d.source.y;
          })
          .attr("x2", function (d) {
            return d.target.x;
          })
          .attr("y2", function (d) {
            return d.target.y;
          });

        node
          .attr("cx", function (d) {
            return d.x;
          })
          .attr("cy", function (d) {
            return d.y;
          });
      }
    });

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }
  </script>
</body>
